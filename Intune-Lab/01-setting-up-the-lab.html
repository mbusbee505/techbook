<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Setting Up The Lab - techbook</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">techbook</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="previous-intune-lab0-project-introduction0-project-introduction"><a class="header" href="#previous-intune-lab0-project-introduction0-project-introduction">Previous: [[Intune-Lab/0. Project Introduction|0. Project Introduction]]</a></h1>
<h1 id="signing-up-for-intune"><a class="header" href="#signing-up-for-intune">Signing Up for Intune</a></h1>
<p>First things first, I had to sign up for the <a href="https://aka.ms/IntuneTrial">Intune Free Trial</a>, provided an email address and a few other pieces of info.</p>
<p>The trial allows for 25 users but we get all the same features as the paid version of the environment.</p>
<p><img src="attachments/01-setting-up-the-lab-1.png" alt="Setting up Intune screenshot 1" /></p>
<h1 id="nuke-the-security-defaults"><a class="header" href="#nuke-the-security-defaults">Nuke The Security Defaults</a></h1>
<p>Next up I needed to turn off the Entra security defaults so theres room for my conditional access policies to take effect without conflict. To do this I went to Entra &gt; Overview &gt; Properties &gt; Manage security defaults and set it to <code>Disabled (not recommended)</code>.</p>
<p><img src="attachments/01-setting-up-the-lab-2.png" alt="Security defaults settings" /></p>
<p>When asked for the reason, I selected "My organization plans to use Conditional Access".</p>
<h1 id="signing-up-for-entra-id"><a class="header" href="#signing-up-for-entra-id">Signing Up for Entra ID</a></h1>
<p>You will need to use <a href="https://signup.microsoft.com/get-started/signup?products=2ebf8ffa-7de1-4d14-9b15-238f5ca77671&amp;mproducts=CFQ7TTC0NZT8:0001&amp;fmproducts=CFQ7TTC0NZT8:0001&amp;ali=1">this page</a> to sign up for Entra ID and use the same Microsoft account as you used for the Intune trial. Once this is complete you will be able to use Entra in your environment.</p>
<p>Before you begin you may need to assign a license to your user. If this happens go to Microsoft 365 Admin Center &gt; Billing &gt; Licenses and ensure there is a license assigned to your user. If not, assign one manually from this page by clicking Microsoft Entra Suite &gt; Users &gt; Assign Licenses and choose yourself.</p>
<p>Next we will move on to adding more users for our organization and ensure they have licenses.</p>
<h1 id="uploading-corporate-workforce"><a class="header" href="#uploading-corporate-workforce">Uploading Corporate Workforce</a></h1>
<p>Every good organization needs at least a few users, so to make things seem more real I'm going to upload to Entra a <a href="https://raw.githubusercontent.com/mbusbee505/IntuneLab/refs/heads/main/busbeecorp_user_import.csv">CSV file of simulated User data</a> that makes up my fake company workforce.</p>
<p>To get to the user upload I went to Entra &gt; Users &gt; Bulk Operations &gt; Bulk Create and selected my file in the search field.</p>
<p><img src="attachments/01-setting-up-the-lab-3.png" alt="Bulk create users" /></p>
<p>If you need a fresh template for new users you can download one provided by Microsoft here as well.</p>
<p>To see that it worked I refreshed the page and went to the All Users section.</p>
<p><img src="attachments/01-setting-up-the-lab-4.png" alt="All users list" /></p>
<h1 id="setting-up-security-groups"><a class="header" href="#setting-up-security-groups">Setting Up Security Groups</a></h1>
<p>With Microsoft Azure you can do most things through the web portal online or using PowerShell. When you want to solve problems at scale or do something in an automated way its sometimes better to use PowerShell. I wanted a way to automate the group creation in this way so I tried with a PowerShell command.</p>
<p>First make sure you have Microsoft Graph installed.</p>
<pre><code>Install-Module Microsoft.Graph -Scope CurrentUser
</code></pre>
<p>Then connect to your tenant:</p>
<pre><code>Connect-MgGraph -Scopes "Group.ReadWrite.All" -TenantID "&lt;Your Tenant ID&gt;"
</code></pre>
<p>The Tenant ID can be found by going to Entra &gt; Overview</p>
<p><img src="attachments/01-setting-up-the-lab-5.png" alt="Tenant ID location" /></p>
<p>After running this command for the first time like I was, you may have a pop-up browser window asking for permission to connect. Make sure to give it the access so you can continue running commands.</p>
<p>To test that the connection works run</p>
<pre><code>Get-MgContext
</code></pre>
<p>It should output some info about your Tenant like below. If this doesn't work you will need to check your connect command again and ensure you are using the right Tenant ID.</p>
<p><img src="attachments/01-setting-up-the-lab-6.png" alt="Get-MgContext output" /></p>
<p>Once I confirmed connection I ran the command below which added the following security groups to Entra. Since its a dynamic group, users and devices will be added to them automatically based on their properties.</p>
<ul>
<li>Exec</li>
<li>HR</li>
<li>Finance</li>
<li>IT</li>
<li>Sales</li>
<li>Marketing</li>
<li>Eng</li>
<li>Support</li>
<li>All-Devices</li>
<li>All-iOS</li>
<li>All-Android</li>
</ul>
<pre><code># Map each DisplayName to its dynamic rule
$dynamicMap = @{
    'Executive'     = '(user.jobTitle -contains "Chief")'
    'Human Resources'       = '(user.department -eq "Human Resources")'
    'Finance'  = '(user.department -eq "Finance")'
    'IT'       = '(user.department -eq "IT")'
    'Security'       = '(user.department -eq "Security")'
    'Research'       = '(user.department -eq "Research")'
    'Sales'    = '(user.department -eq "Sales")'
    'Marketing'= '(user.department -eq "Marketing")'
    'Engineering'      = '(user.department -eq "Engineering")'
    'Support'  = '(user.department -eq "Support")'
    'All-Devices' = '(device.deviceId -ne null)'      # dynamic **device** group
    'All-iOS'     = '(device.deviceOSType -contains "iOS")'
    'All-Android' = '(device.deviceOSType -contains "Android")'
}

foreach ($kv in $dynamicMap.GetEnumerator()) {
    $name = $kv.Key
    $rule = $kv.Value

    $params = @{
        DisplayName                 =  $name
        MailNickname                = ($name -replace '\s','')
        Description                 = "$name dynamic security group"
        SecurityEnabled             = $true          # keeps it a security group
        MailEnabled                 = $false
        GroupTypes                  = @('DynamicMembership')
        MembershipRule              = $rule
        MembershipRuleProcessingState = 'On'
    }

    New-MgGroup @params
}
</code></pre>
<p><img src="attachments/01-setting-up-the-lab-7.png" alt="PowerShell group creation success" /></p>
<p>Once I saw the success screen come through I went to Entra &gt; Groups &gt; All Groups and found the groups added via PowerShell.</p>
<p><img src="attachments/01-setting-up-the-lab-8.png" alt="All groups view" /></p>
<p>According to Microsoft, it can take up to 24 hours for these groups to apply to users. While I waited for this to end I moved on to setting up a dynamic device group for Windows 11 devices.</p>
<p><img src="attachments/01-setting-up-the-lab-9.png" alt="Dynamic device group" /></p>
<p>In the <code>Add dynamic query</code> page I added the following settings:</p>
<p><img src="attachments/01-setting-up-the-lab-10.png" alt="Dynamic query settings" /></p>
<h1 id="assigning-entraintune-licenses"><a class="header" href="#assigning-entraintune-licenses">Assigning Entra+Intune Licenses</a></h1>
<p>I discovered in order to get the Automatic Enrollment to work on Intune during the OOBE setup I needed each user to have an Entra and Intune license assigned. Since I had only signed up for the Intune Trial so far, I had to go back and make sure to sign up for an Entra ID Free Trial as well under the same Microsoft account.</p>
<p>The Free Trials for Entra and Intune both came with 25 users each so I decided to cull my workforce down to 25 users (including myself), then apply the licenses to each user. I did not want to apply to all users, just those that are employees of the company. The smartest way to do this seemed to be by creating a dynamic group based on the user's Company Name property and assign licenses to members of that group.</p>
<p>First I needed to set the Company Name property correctly for all 25 of my current users, since I know these are all employees. The following PowerShell commands set the Company Name for all users.</p>
<pre><code>$CompanyName = "BusbeeCorp"
$domain      = "@busbeecorp.onmicrosoft.com"

Get-MgUser `
    -Filter "endswith(userPrincipalName,'$domain')" `
    -ConsistencyLevel eventual `
    -All |                             
ForEach-Object {
    Update-MgUser -UserId $_.Id -CompanyName $CompanyName
}
</code></pre>
<blockquote>
<p>In the real world I would want to make sure data entry for each new user is happening correctly.</p>
</blockquote>
<p>With the Company Name set I just needed to create a dynamic group for All-Employees based on the Company Name property BusbeeCorp</p>
<pre><code>$rule = 'user.companyName -eq "BusbeeCorp"'

New-MgGroup -DisplayName "All-Employees" `
            -Description "Every Employee of BusbeeCorp" `
            -MailEnabled:$false `
            -SecurityEnabled:$true `
            -MailNickname "all-employees" `
            -GroupTypes "DynamicMembership" `
            -MembershipRule $rule `
            -MembershipRuleProcessingState "On"
</code></pre>
<p>I found that to get the Licenses assigned to the All-Employees group I had to first update Microsoft Graph to get a few modules not included by default.The following command will install this and open a new PowerShell session.</p>
<pre><code>Register-PSRepository -Name PSGallery -SourceLocation "https://www.powershellgallery.com/api/v2" -InstallationPolicy Trusted -ErrorAction SilentlyContinue

Install-Module Microsoft.Graph -Scope CurrentUser -Force
pwsh 
</code></pre>
<p>Once in the new session I ran the commands below to apply the License SKUs to the All-Employees group.</p>
<pre><code>Connect-MgGraph -Scopes "Directory.ReadWrite.All","LicenseAssignment.ReadWrite.All","Group.ReadWrite.All"

$skuIntune  = "061f9ace-7d42-4136-88ac-31dc755f143f"
$skuEntraP2 = "f9602137-2203-447b-9fff-41b36e08ce5d"
$groupId    = (Get-MgGroup -Filter "displayName eq 'All-Employees'").Id

Set-MgGroupLicense -GroupId $groupId `
    -AddLicenses  @(@{SkuId=$skuIntune}, @{SkuId=$skuEntraP2}) `
    -RemoveLicenses @()
</code></pre>
<p>I confirmed this took effect by going to Entra &gt; Billing &gt; Licenses &gt; All Products and saw 25 Assigned licenses for each product.</p>
<p><img src="attachments/01-setting-up-the-lab-11.png" alt="Assigned licenses" /></p>
<h1 id="signing-up-for-defender-for-endpoint"><a class="header" href="#signing-up-for-defender-for-endpoint">Signing Up for Defender for Endpoint</a></h1>
<p>First, Go to the sign up page for <a href="https://www.microsoft.com/en-us/security/business/endpoint-security/microsoft-defender-endpoint">Microsoft Defender for Endpoint P2 Free Trial</a> and sign up using the same login you used for the rest of the lab. Complete the sign up flow, then go to <code>Microsoft 365 Admin Center &gt; Billing &gt; Licenses</code> page and click Microsoft Defender for Endpoint P2. In this page click <code>Groups &gt; Assign Licenses</code> and assign them to the All-Employees group.</p>
<p>Next we can setup Defender for Endpoint to connect with each of our devices in Intune so we can get visibility over the devices security and compliance status. Defender for Endpoint provides comprehensive protection for endpoint devices to guard users and provide better management capabilities for IT admins.</p>
<p>To configure Defender for Endpoint you must first connect it to the Intune environment. In Intune go to <code>Intune &gt; Endpoint security &gt; Microsoft Defender for Endpoint</code> and set the following setting:</p>
<ul>
<li><strong>Allow Microsoft Defender for Endpoint to enforce Endpoint Security Configurations</strong>: On</li>
</ul>
<p>This will let Defender control the configurations within the Intune environment.</p>
<p>You will next need to go to the Defender portal and connect Defender to Intune on the other side. Go to <code>Defender &gt; Settings &gt; Endpoint &gt; Advanced Features &gt; Microsoft Intune Connection</code> and set it to On.</p>
<p>On the Intune side you will need to go to <code>Intune &gt; Tenant Administration &gt; Connectors and tokens &gt; Microsoft Defender for Endpoint</code> and make sure all devices are set to connect to MDE.</p>
<p><img src="attachments/01-setting-up-the-lab-13.png" alt="Defender for Endpoint connection" /></p>
<p>These being connected ensures Defender for Endpoint is able to connect to the Intune devices.</p>
<h1 id="next-2-enrolling-devices"><a class="header" href="#next-2-enrolling-devices">Next: [[2. Enrolling Devices]]</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../Intune-Lab/introduction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../Intune-Lab/02-enrolling-devices.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../Intune-Lab/introduction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../Intune-Lab/02-enrolling-devices.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
